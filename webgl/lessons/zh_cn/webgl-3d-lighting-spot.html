<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/zh_cn/webgl-3d-lighting-spot.md. Do not edited directly -->
<!--
Copyright 2021 GFXFundamentals.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of GFXFundamentals. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="如何在 WebGL 中实现聚光灯的效果">
<meta name="keywords" content="webgl graphics">
<meta name="thumbnail" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-spot_zh-cn.jpg">

<meta property="og:title" content="WebGL 三维聚光灯">
<meta property="og:type" content="website">
<meta property="og:image" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-spot_zh-cn.jpg">
<meta property="og:description" content="如何在 WebGL 中实现聚光灯的效果">
<meta property="og:url" content="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@greggman">
<meta name="twitter:creator" content="@greggman">
<meta name="twitter:domain" content="webglfundamentals.org">
<meta name="twitter:title" content="WebGL 三维聚光灯">
<meta name="twitter:url" content="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">
<meta name="twitter:description" content="如何在 WebGL 中实现聚光灯的效果">
<meta name="twitter:image:src" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-spot_zh-cn.jpg">

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webglfundamentals.org/#website",
      "url":"https://webglfundamentals.org/",
      "name":"WebglFundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html#primaryimage",
      "url":"https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-spot_zh-cn.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html#webpage",
      "url":"https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html",
      "inLanguage":"zh-cn",
      "name":"WebGL 三维聚光灯",
      "keywords":"webgl graphics programming",
      "isPartOf":{
        "@id":"https://webglfundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html#primaryimage"
      }
    }
  ]
}
</script>


<title>WebGL 三维聚光灯</title>
<link href="/webgl/lessons/resources/webglfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/lang.css">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css">

  <link rel="alternate" hreflang="en" href="https://webglfundamentals.org/webgl/lessons/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="fr" href="https://webglfundamentals.org/webgl/lessons/fr/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="ja" href="https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="ko" href="https://webglfundamentals.org/webgl/lessons/ko/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="pl" href="https://webglfundamentals.org/webgl/lessons/pl/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="pt-br" href="https://webglfundamentals.org/webgl/lessons/pt-br/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="ru" href="https://webglfundamentals.org/webgl/lessons/ru/webgl-3d-lighting-spot.html">
  <link rel="alternate" hreflang="zh_cn" href="https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">




</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-3d-lighting-spot.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-3d-lighting-spot.html" >Français</a>
    <option value="/webgl/lessons/ja/webgl-3d-lighting-spot.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-3d-lighting-spot.html" >한국어</a>
    <option value="/webgl/lessons/pl/webgl-3d-lighting-spot.html" >Polski</a>
    <option value="/webgl/lessons/pt-br/webgl-3d-lighting-spot.html" >Portuguese</a>
    <option value="/webgl/lessons/ru/webgl-3d-lighting-spot.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html" selected>简体中文</a>
</select>


    <a href="#toc">目录</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/zh_cn/">WebGLFundamentals.org</a></h1>
<style>
#forkongithub>div {
    background: #000;
    color: #fff;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 1.3rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 400px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(200px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a {
  text-decoration: none;
  color: #fff;
}
#forkongithub>div:hover {
    background: #c11;
    color: #fff;
}
#forkongithub .contributors {
  font-size: 0.75rem;
  background: rgba(255,255,255,0.2);
  line-height: 1.2;
  padding: 0.1em;
}
#forkongithub>div::before,#forkongithub>div::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub>div::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
#forkongithub img {
  width: 1em;
  height: 1em;
  border-radius: 100%;
  vertical-align: middle;
}

@media (max-width: 900px) {
    #forkongithub>div {
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub>div {
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><div><div><a href="https://github.com/gfxfundamentals/webgl-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div></div></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL 三维聚光灯</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>此文上接<a href="webgl-3d-lighting-point.html">WebGL 三维点光源</a>，
如果没读建议从<a href="webgl-3d-lighting-point.html">那里开始</a>。</p>
<p>在上篇文章中我们讲到点光源，计算光源到物体表面每一点的方向，然后做与
<a href="webgl-3d-lighting-directional.html">方向光</a>相同的运算，
也就是对光线方向和表面法向量（表面面对的方向）做点乘运算。
如果两个方向完全相同就会得到 1，应该被完全照亮。
如果两个方向垂直会得到0，相反会得到 -1。我们直接将这个值和表面的颜色相乘，
实现光照效果。</p>
<p>聚光灯只是做了少量修改，事实上如果你比较有创新能力的话，可能会根据之前学的东西知道聚光灯的实现方法。</p>
<p>你可以把点光源想象成一个点，光线从那个点照向所有方向。
实现聚光灯只需要以那个点为起点选择一个方向，作为聚光灯的方向，
然后将其他光线方向与所选方向点乘，然后随意选择一个限定范围，
然后判断光线是否在限定范围内，如果不在就不照亮。</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example noborder" style="width: 500px; height: 400px;" src="/webgl/lessons/resources/spot-lighting.html"></iframe>
</div>

</p>
<p>在上方的图示中我们开一看到光线照向所有的方向，并且将每个方向的点乘结果显示在上面。
然后指定一个方向<strong>方向</strong>表示聚光灯的方向，选择一个限定（上方以度为单位）。
通过限定我们计算一个<strong>点乘限定</strong>，只需对限定值取余弦就可以得到。如果与选定聚光灯方向的点乘大于这个点乘限定，就照亮，否则不照亮。</p>
<p>换一种方式解释，假设限定是 20 度，我们可以将它转换为弧度，然后取余弦值得到 -1 到 1 之间的数，
暂且把它称作点乘空间。或者可以用这个表格表示限定值的转换。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">            限制值
   角度   |   弧度   | 点乘空间
 --------+---------+----------
    0    |   0.0   |    1.0
    22   |    .38  |     .93
    45   |    .79  |     .71
    67   |   1.17  |     .39
    90   |   1.57  |    0.0
   180   |   3.14  |   -1.0
</code></pre><p>我们可以只需判断</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">dotFromDirection = dot(surfaceToLight, -lightDirection)
if (dotFromDirection &gt;= limitInDotSpace) {
   // 使用光照
}
</code></pre><p>让我们来实现它。</p>
<p>首先修改<a href="webgl-3d-lighting-point.html">上文</a>的片段着色器。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">precision mediump float;

// 从顶点着色器传入的值
varying vec3 v_normal;
varying vec3 v_surfaceToLight;
varying vec3 v_surfaceToView;

uniform vec4 u_color;
uniform float u_shininess;
+uniform vec3 u_lightDirection;
+uniform float u_limit;          // 在点乘空间中

void main() {
  // 因为 v_normal 是可变量，被插值过
  // 所以不是单位向量，单位可以让它成为再次成为单位向量
  vec3 normal = normalize(v_normal);

  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);
  vec3 surfaceToViewDirection = normalize(v_surfaceToView);
  vec3 halfVector = normalize(surfaceToLightDirection + surfaceToViewDirection);

-  float light = dot(normal, surfaceToLightDirection);
+  float light = 0.0;
  float specular = 0.0;

+  float dotFromDirection = dot(surfaceToLightDirection,
+                               -u_lightDirection);
+  if (dotFromDirection &gt;= u_limit) {
*    light = dot(normal, surfaceToLightDirection);
*    if (light &gt; 0.0) {
*      specular = pow(dot(normal, halfVector), u_shininess);
*    }
+  }

  gl_FragColor = u_color;

  // 只将颜色部分（不包含 alpha） 和光照相乘
  gl_FragColor.rgb *= light;

  // 直接加上高光
  gl_FragColor.rgb += specular;
}
</code></pre><p>当然我们需要找到刚才添加的全局变量的位置。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  var lightDirection = [?, ?, ?];
  var limit = degToRad(20);

  ...

  var lightDirectionLocation = gl.getUniformLocation(program, &quot;u_lightDirection&quot;);
  var limitLocation = gl.getUniformLocation(program, &quot;u_limit&quot;);
</code></pre><p>然后设置它们</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">    gl.uniform3fv(lightDirectionLocation, lightDirection);
    gl.uniform1f(limitLocation, Math.cos(limit));
</code></pre><p>这是结果</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-spot.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-spot.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>一些需要注意的细节：一个是我们在上方对 <code class="notranslate" translate="no">u_lightDirection</code> 取负，
这其实是一个等价的选择，我们希望两个方向匹配的时候能指向相同的方向，
也就是需要将 surfaceToLightDirection 和聚光灯的反方向相比，
我们可以用很多种方式实现这个。可以在设置全局变量时传入反方向，
那可能是我的首选，但是我觉得那样应该叫做 <code class="notranslate" translate="no">u_reverseLightDirection</code> 或 <code class="notranslate" translate="no">u_negativeLightDirection</code>
而不是 <code class="notranslate" translate="no">u_lightDirection</code>。</p>
<p>另一件事，也许这个只是个人习惯，如果可能的话我尽量不在着色器中使用条件语句，
原因是我认为着色器并不是真的使用条件语句，如果你在着色器中使用着色器，
编译器会在代码中扩展很多 0 和 1 的乘法运算来实现，所以这里并不是真的条件语句，
它会将你的代码扩展成多种组合。我不确定现在是否还是这样，但是我们可以使用一些技巧来避免这种情况，
你自己可以选择用或不用。</p>
<p>有一个 GLSL 函数叫做 <code class="notranslate" translate="no">step</code>，它获取两个值，如果第二个值大于或等于第一个值就返回 1.0，
否则返回 0。用JavaScript大概可以这样表示。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">function step(a, b) {
   if (b &gt;= a) {
       return 1;
   } else {
       return 0;
   }
}
</code></pre><p>让我们使用 <code class="notranslate" translate="no">step</code> 避免这种情况</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  float dotFromDirection = dot(surfaceToLightDirection,
                               -u_lightDirection);
  // 如果光线在聚光灯范围内 inLight 就为 1，否则为 0
  float inLight = step(u_limit, dotFromDirection);
  float light = inLight * dot(normal, surfaceToLightDirection);
  float specular = inLight * pow(dot(normal, halfVector), u_shininess);
</code></pre><p>看起来没有什么区别，这是结果</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-spot-using-step.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-spot-using-step.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>还有一件事，现在的聚光灯效果非常粗糙和僵硬。只有在聚光灯范围内或外，
在外面就直接变黑，没有任何过渡。</p>
<p>要修正它我们可以使用两个限定值代替原来的一个，
一个内部限定一个外部限定。如果在内部限定内就使用 1.0，
在外部限定外面就使用 0.0，在内部和外部限定之间就使用 1.0 到 0.0 之间的插值。</p>
<p>这是我们实现这个的一种方式</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">-uniform float u_limit;          // 在点乘空间中
+uniform float u_innerLimit;     // 在点乘空间中
+uniform float u_outerLimit;     // 在点乘空间中

...

  float dotFromDirection = dot(surfaceToLightDirection,
                               -u_lightDirection);
-  float inLight = step(u_limit, dotFromDirection);
+  float limitRange = u_innerLimit - u_outerLimit;
+  float inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);
  float light = inLight * dot(normal, surfaceToLightDirection);
  float specular = inLight * pow(dot(normal, halfVector), u_shininess);
</code></pre><p>这样就行了</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-spot-falloff.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-spot-falloff.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>现在我们得到了聚光灯的效果。</p>
<p>需要注意的事如果 <code class="notranslate" translate="no">u_innerLimit</code> 和 <code class="notranslate" translate="no">u_outerLimit</code>相等那么 <code class="notranslate" translate="no">limitRange</code>
就会是 0.0 。除以 0 就会导致 undefined。这在着色器中没有什么解决办法，
所以只需要在JavaScript中确保 <code class="notranslate" translate="no">u_innerLimit</code> 和 <code class="notranslate" translate="no">u_outerLimit</code> 永远不要相等。
（注意：示例代码中并没有做这个。）</p>
<p>GLSL 也有一个函数可以稍微做一些简化，叫做 <code class="notranslate" translate="no">smoothstep</code>，和 <code class="notranslate" translate="no">step</code> 相似返回一个 0 到 1
之间的值，但是它获取最大和最小边界值，返回该值在边界范围映射到 0 到 1 之间的插值。</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no"> smoothstep(lowerBound, upperBound, value)
</code></pre><p>让我们来实现它</p>
<pre class="prettyprint notranslate" translate="no"><code class="notranslate" translate="no">  float dotFromDirection = dot(surfaceToLightDirection,
                               -u_lightDirection);
-  float limitRange = u_innerLimit - u_outerLimit;
-  float inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);
  float inLight = smoothstep(u_outerLimit, u_innerLimit, dotFromDirection);
  float light = inLight * dot(normal, surfaceToLightDirection);
  float specular = inLight * pow(dot(normal, halfVector), u_shininess);
</code></pre><p>这样也可以</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-spot-falloff-using-smoothstep.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-spot-falloff-using-smoothstep.html" target="_blank">点此在新窗口中浏览</a>
</div>

</p>
<p>不同之处是 <code class="notranslate" translate="no">smoothstep</code> 使用 Hermite 插值而不是线型插值，
也就是说 <code class="notranslate" translate="no">lowerBound</code> 和 <code class="notranslate" translate="no">upperBound</code> 之间的值插值后像下方右图所示，
线型插值是左图。</p>
<p><img class="webgl_center invertdark" src="../resources/linear-vs-hermite.png" /></p>
<p>如果你觉得没什么关系的话，使用什么取决于你自己。</p>
<p>还有一件事就是注意当 <code class="notranslate" translate="no">lowerBound</code> 大于或等于 <code class="notranslate" translate="no">upperBound</code> 时 <code class="notranslate" translate="no">smoothstep</code>
方法会产生 undefined。它们值相等和志强的情况一样，多出的问题是 <code class="notranslate" translate="no">lowerBound</code> 大于
<code class="notranslate" translate="no">upperBound</code> 时，但是对于正常的聚光灯这种情况永远不会出现。</p>
<div class="webgl_bottombar">
<h3>小心 GLSL 中的 undefined 情况</h3>
<p>
GLSL 中的一些函数在某些情况下会出现 undefined，对一个负值使用<code class="notranslate" translate="no">pow</code>求幂就是一个例子，
因为结果是无法预期。我们遇到的另一个例子就是上方的<code class="notranslate" translate="no">smoothstep</code>。
<p>
你应该注意这些情况，否则你的着色器会在不同的设备上得到不同的结果。
<a href="https://www.khronos.org/files/opengles_shading_language.pdf">规范第 8 节</a>
列出了所有内置函数，它们的用法，是否会出现 undefined 情况。</p>
<p>这是会出现undefined情况的列表。注意<code class="notranslate" translate="no">genType</code> 表示 <code class="notranslate" translate="no">float</code>, <code class="notranslate" translate="no">vec2</code>, <code class="notranslate" translate="no">vec3</code>, 或 <code class="notranslate" translate="no">vec4</code>。</p>
<pre class="prettyprint"><code class="notranslate" translate="no">genType asin (genType x)</code></pre><p>反正弦函数，返回角度 x 的反正弦值，返回值在 [−π/2, π/2] 之间，如果 ∣x∣ > 1 导致undefined。</p>


<pre class="prettyprint"><code class="notranslate" translate="no">genType acos (genType x)</code></pre><p>反余弦函数。返回角度 x 的反余弦值，返回值范围为[0, π]，
如果 ∣x∣ > 1 导致undefined。</p>



<pre class="prettyprint"><code class="notranslate" translate="no">genType atan (genType y, genType x)</code></pre><p>反正切函数。返回一个正切为 y/x 的角度，
x 和 y 的符号决定象限，返回值范围为[−π,π]，如果 x 和 y 都是 0 导致undefined。</p>


<pre class="prettyprint"><code class="notranslate" translate="no">genType pow (genType x, genType y)</code></pre><p>返回 x 的 y 次幂, 例如, x<sup>y</sup>。
如果 x < 0 导致undefined，如果 x = 0 并且 y <= 0 导致undefined。</p>


<pre class="prettyprint"><code class="notranslate" translate="no">genType log (genType x)</code></pre><p>返回 x 的自然对数, 例如, 返回 y 值满足 x = e<sup>y</sup>。
如果 x <= 0 导致undefinded。</p>


<pre class="prettyprint"><code class="notranslate" translate="no">genType log2 (genType x)</code></pre><p>返回以 2 为底 x 的对数。例如，返回 y 满足 x=2<sup>y</sup>。
如果 x <= 0 导致undefinded。</p>



<pre class="prettyprint"><code class="notranslate" translate="no">genType sqrt (genType x)</code></pre><p>返回 √x .
如果 x < 0 导致undefinded。</p>


<pre class="prettyprint"><code class="notranslate" translate="no">genType inversesqrt (genType x)</code></pre><p>
返回 1/√x.
如果 x <= 0 导致undefinded。</p>


<pre class="prettyprint"><code class="notranslate" translate="no">genType clamp (genType x, genType minVal, genType maxVal)
genType clamp (genType x, float minVal, float maxVal)</code></pre><p>
返回 min (max (x, minVal), maxVal).
如果 minVal > maxVal 导致undefined。</p>



<pre class="prettyprint"><code class="notranslate" translate="no">genType smoothstep (genType edge0, genType edge1, genType x)
genType smoothstep (float edge0, float edge1, genType x)</code></pre><p>
如果 x <= edge0 返回 0.0，如果 x >= edge1 返回 1.0，
当 edge0 < x < edge1 使用 Hermite 插值到 0 到 1 之间。
当你希望在阈值范围内平滑插值时这个函数就很有用。相当于：
</p>
<pre class="prettyprint">
 genType t;
 t = clamp ((x – edge0) / (edge1 – edge0), 0, 1);
 return t * t * (3 – 2 * t);
</pre>
<p>如果 edge0 >= edge1 导致undefined。</p>





</div>


    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-3d-lighting-spot.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-3d-lighting-spot.html" >Français</a>
    <option value="/webgl/lessons/ja/webgl-3d-lighting-spot.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-3d-lighting-spot.html" >한국어</a>
    <option value="/webgl/lessons/pl/webgl-3d-lighting-spot.html" >Polski</a>
    <option value="/webgl/lessons/pt-br/webgl-3d-lighting-spot.html" >Portuguese</a>
    <option value="/webgl/lessons/ru/webgl-3d-lighting-spot.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html" selected>简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>基础概念</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-fundamentals.html">WebGL 基础概念</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-how-it-works.html">WebGL 工作原理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shaders-and-glsl.html">WebGL 着色器和GLSL</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html">WebGL State Diagram</a></li>
        </ul>
  <li>图像处理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-image-processing.html">WebGL 图像处理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-image-processing-continued.html">WebGL 进一步处理图像</a></li>
        </ul>
  <li>二维平移，旋转，缩放和矩阵运算</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-translation.html">WebGL 二维平移</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-rotation.html">WebGL 二维旋转</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-scale.html">WebGL 二维缩放</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrices.html">WebGL 二维矩阵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-orthographic.html">WebGL 三维正射投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective.html">WebGL 三维透视投影</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-camera.html">WebGL 三维相机</a></li>
        </ul>
  <li>光照</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-directional.html">WebGL 三维方向光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-point.html">WebGL 三维点光源</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-lighting-spot.html">WebGL 三维聚光灯</a></li>
        </ul>
  <li>组织和重构</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-less-code-more-fun.html">WebGL 码少趣多</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-multiple-things.html">WebGL 绘制多个物体</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-scene-graph.html">WebGL 场景图</a></li>
        </ul>
  <li>几何</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-geometry-lathe.html">WebGL 三维几何加工</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj.html">WebGL 加载 .obj 文件</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-load-obj-w-mtl.html">WebGL 加载带 .mtl 的 .obj 文件</a></li>
        </ul>
  <li>纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-3d-textures.html">WebGL 三维纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-data-textures.html">WebGL 数据纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2-textures.html">WebGL 使用多个纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cors-permission.html">WebGL 跨域图像</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-3d-perspective-correct-texturemapping.html">WebGL 纹理映射的透视纠正</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-planar-projection-mapping.html">平面的和透视的投影映射</a></li>
        </ul>
  <li>渲染到纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-render-to-texture.html">WebGL 渲染到纹理</a></li>
        </ul>
  <li>阴影</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-shadows.html">阴影</a></li>
        </ul>
  <li>技术</li>
        <ul>
            <li>二维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-2d-drawimage.html">WebGL 二维DrawImage</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-matrix-stack.html">WebGL 二维矩阵栈</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-sprites.html">精灵</a></li>
        </ul>
  <li>三维</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-cube-maps.html">WebGL 立方体贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-environment-maps.html">WebGL 环境贴图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skybox.html">WebGL 天空盒</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-skinning.html">WebGL 蒙皮</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-fog.html">WebGL 雾</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-picking.html">抓取 (点击的东西)</a></li>
        </ul>
  <li>文字</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-text-html.html">WebGL 文字 - HTML</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-canvas2d.html">WebGL 文字 - 二维Canvas</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-texture.html">WebGL 文字 - 使用纹理</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-text-glyphs.html">WebGL 文字 - 使用字形纹理</a></li>
        </ul>
  <li>纹理</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-ramp-textures.html">Ramp Textures (Toon Shading)</a></li>
        </ul>
  <li>GPGPU</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-gpgpu.html">GPGPU</a></li>
        </ul>
        </ul>
  <li>建议</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-smallest-programs.html">WebGL 最小的程序</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-drawing-without-data.html">无数据绘图</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-pulling-vertices.html">Pulling Vertices</a></li>
        </ul>
  <li>优化</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-indexed-vertices.html">顶点索引 （gl.drawElements)</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-instanced-drawing.html">实例化绘制</a></li>
        </ul>
  <li>杂项</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-setup-and-installation.html">WebGL 设置和安装</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-boilerplate.html">WebGL 样板</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-resizing-the-canvas.html">WebGL 重置画布尺寸</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-animation.html">WebGL 动画</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-points-lines-triangles.html">WebGL 点、线和三角</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-multiple-views.html">Multiple Views, Multiple Canvases</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-visualizing-the-camera.html">可视化相机</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-and-alpha.html">WebGL 和阿尔法通道</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-2d-vs-3d-library.html">WebGL 2D vs 3D 库</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-anti-patterns.html">WebGL 错误模式</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-matrix-vs-math.html">WebGL 矩阵 vs 数学中的矩阵</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-precision-issues.html">Precision Issues</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#screenshot">截屏</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#preservedrawingbuffer">防止画布被清空</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#tabindex">在画布中获取键盘输入</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-tips.html#html-background">将 WebGL 作为 HTML 的背景</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-cross-platform-issues.html">WebGL 跨平台相关问题</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-qna.html">Questions and Answers</a></li>
        </ul>
  <li>参考</li>
        <ul>
          <li><a href="/webgl/lessons/zh_cn/webgl-attributes.html">WebGL 属性</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-texture-units.html">WebGL 纹理单元</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-framebuffers.html">WebGL 帧缓冲</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-readpixels.html">WebGL readPixels</a></li>
<li><a href="/webgl/lessons/zh_cn/webgl-references.html">WebGL 参考</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">API 帮助文档</a></li>
  <li><a href="https://twgljs.org">TWGL, 一个轻量级WebGL辅助库</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl-fundamentals">GitHub</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        
    <div>有疑问? <a href="https://stackoverflow.com/questions/tagged/webgl">在stackoverflow上提问</a>.</div>
    <div>Issue/Bug? <a href="https://github.com/gfxfundamentals/webgl-fundamentals/issues">在GitHub上提issue</a>.</div>
    <div class="lesson-comment-notes">
       使用 <b>&lt;pre&gt;&lt;code&gt;</b> 代码 <b>&lt;/code&gt;&lt;/pre&gt;</b> 的格式编写代码块
    </div>
  

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webglfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL 三维聚光灯';
            var disqus_title = 'WebGL 三维聚光灯';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script>
const settings = {
  contribTemplate: "感谢 <a href=\"${html_url}\"><img src=\"${avatar_url}\"> ${login}</a><br>的 <a href=\"https://github.com/${owner}/${repo}/commits?author=${login}\">${contributions} 次贡献</a>",
  owner: "gfxfundamentals",
  repo: "webgl-fundamentals",
};
</script>
<script src="/contributors.js"></script>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js" type="module"></script>
<script>
(function() {
  if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
      return;
  }

  function addScript(src, type, fn) {
    const script = document.createElement('script');
    const firstScript = document.getElementsByTagName('script')[0];
    script.async = true;
    script.defer = true;
    script.type = type || 'javascript';
    if (fn) {
      script.addEventListener('load', fn);
    }
    script.src = src;
    firstScript.parentNode.insertBefore(script, firstScript);
  }

  // can't do this because it would eat contexts
  //addScript('//gpustats.org/stats.js', 'module');

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59804936-1', 'auto');
  ga('send', 'pageview');
}());
</script>


</html>



